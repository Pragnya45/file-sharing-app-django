{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Upload</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- FilePond Styles -->
    <link
      href="https://unpkg.com/filepond/dist/filepond.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
      rel="stylesheet"
    />

    <!-- Custom Styling -->
    <style>
      body {
        background: linear-gradient(to right, #83a4d4, #b6fbff);
        font-family: "Segoe UI", sans-serif;
        padding-top: 5vh;
      }

      .upload-card {
        max-width: 600px;
        margin: auto;
        background: white;
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
      }

      .upload-card h2 {
        font-weight: 700;
        color: #0277bd;
      }

      .filepond--panel-root {
        border-radius: 12px;
      }

      .success-card {
        display: none;
        background-color: #d1e7dd;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1.5rem;
        text-align: center;
        transition: all 0.3s ease-in-out;
      }

      .clipboard-btn {
        background: #ffc107;
        border: none;
        padding: 0.75rem 1.25rem;
        border-radius: 30px;
        font-weight: bold;
        color: #212529;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: 0.2s ease-in-out;
      }

      .clipboard-btn:hover {
        transform: scale(1.05);
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="upload-card text-center">
        <img
          src="{% static 'image/undraw.svg' %}"
          class="img-fluid mb-3"
          style="max-height: 180px"
          alt="upload"
        />
        <h2 class="heading">Upload Your Files</h2>
        <p class="text-muted">
          You can upload multiple files and generate a shareable download link
        </p>

        <input type="file" class="my-pond mt-3" multiple name="filepond" />

        <button class="btn btn-primary mt-4" onclick="upload_file()">
          Upload
        </button>

        <div class="success-card" id="btn">
          <p class="mb-2"><strong>Your download link is ready!</strong></p>
          <button onclick="copyClip()" class="clipboard-btn">
            Copy Download Link
          </button>
          <p class="mt-2 small text-muted">Click the button to copy the URL</p>
        </div>
      </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
    <script src="https://unpkg.com/filepond/dist/filepond.min.js"></script>
    <script src="https://unpkg.com/jquery-filepond/filepond.jquery.js"></script>

    <script>
      FilePond.registerPlugin(FilePondPluginImagePreview);
      const pond = FilePond.create(document.querySelector(".my-pond"));

      let url = null;

      function upload_file() {
        const files = pond.getFiles();
        const formdata = new FormData();

        for (let i = 0; i < files.length; i++) {
          formdata.append("files", files[i].file);
        }

        fetch("/handle/", {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: formdata,
        })
          .then((res) => res.json())
          .then((result) => {
            console.log(result);
            if (result.status === 200) {
              const url = `/download/${result.data.folder}`;
              const fullUrl = `${window.location.origin}${url}`;

              document.getElementById("btn").style.display = "block";
              document.getElementById("btn").href = fullUrl;
              console.log("Download Link:", fullUrl);
            } else {
              alert("Upload failed: " + result.message);
            }
          })
          .catch((err) => {
            alert("Something went wrong!");
            console.error(err);
          });
      }

      function copyClip() {
        if (url) {
          navigator.clipboard.writeText(url).then(() => {
            alert("Copied the link: " + url);
          });
        }
      }
    </script>
  </body>
</html>
